# Tutorial Transition Setup Guide

This guide explains how the first-time tutorial combat sequence works when the player exits the Startroom.

## Overview

When the player exits the Startroom for the first time:
1. Screen fades to black
2. Party dialogue appears:
   - Magician: "It's sure pretty dark here"
   - Fighter: "How did no one think to bring a torch..."
   - Ranger: "Is that our footsteps? or something else?"
   - Bard: "Something's charging at us!"
3. Game transitions to Battle_Tutorial scene
4. After winning tutorial combat, player is placed at bottom of Overworld_Entrance

On subsequent exits from Startroom (after tutorial is completed), the player goes directly to Overworld_Entrance.

## Files Created/Modified

### New Files Created:
1. **FirstTutorialTrigger.cs** - Component that intercepts Startroom exit and checks tutorial status
2. **TutorialIntro.ink** - Ink dialogue file for the pre-combat dialogue
3. **TutorialIntro.json** - Compiled ink dialogue (auto-generated by Unity)

### Modified Files:
1. **SceneTransitionManager.cs** - Added special handling for post-tutorial transition
2. **ProjectSettings/EditorBuildSettings.asset** - Added Battle_Tutorial scene to build
3. **PersistentGameManager.cs** - Uses existing `SetCustomDataValue`/`GetCustomDataValue` to track tutorial completion

## Unity Setup Instructions

### Step 1: Setup Overworld_Startroom Scene

1. Open `Overworld_Startroom` scene in Unity
2. Find the exit transition area (the collider that transitions player to Overworld_Entrance)
3. **Option A - Replace Existing TransitionArea:**
   - Select the GameObject with `TransitionArea` component
   - Remove the `TransitionArea` component
   - Add the `FirstTutorialTrigger` component instead
   
4. **Option B - Create New Tutorial Exit:**
   - Create a new GameObject (Right-click in Hierarchy → Create Empty)
   - Name it "TutorialExit"
   - Add a `BoxCollider2D` component
   - Set the collider to be a trigger (check "Is Trigger")
   - Position and size the collider where the player should exit
   - Add the `FirstTutorialTrigger` component

5. **Configure FirstTutorialTrigger:**
   - **Target Scene Name**: `Overworld_Entrance`
   - **Target Marker Id**: `bottom_entrance` (or whatever marker you use)
   - **Tutorial Intro Dialogue**: Drag `Assets/Ink/TutorialIntro.json` here
   - **Auto Transition**: ✓ Checked

### Step 2: Setup Overworld_Entrance Scene

Make sure there's a spawn marker at the bottom of the scene:

1. Open `Overworld_Entrance` scene
2. Find or create a GameObject named something like "SpawnMarker_Bottom"
3. Add a `PlayerSpawnMarker` component (if you have one) or just ensure it has a unique identifier
4. Make sure the marker's ID matches what you set in FirstTutorialTrigger (default: `bottom_entrance`)

### Step 3: Verify Battle_Tutorial Scene

The Battle_Tutorial scene should already be set up with:
- Combat manager
- Player characters
- Tutorial enemy
- Tutorial dialogue triggers (optional)

The scene is now included in the build settings automatically.

### Step 4: Test the Flow

1. **First Run Test:**
   - Start a new game or reset PersistentGameManager data (press F9 in game, then click "RESET ALL DATA")
   - Play through to Startroom exit
   - You should see:
     - Screen goes black
     - Dialogue appears with party members talking
     - Press Z to advance through dialogue
     - Battle_Tutorial scene loads
     - After winning, you're placed at bottom of Overworld_Entrance

2. **Second Run Test:**
   - Exit Overworld_Entrance and return to Startroom
   - Exit Startroom again
   - This time you should go directly to Overworld_Entrance (no tutorial)

## How It Works

### Tutorial State Tracking

The tutorial completion is tracked using PersistentGameManager's custom data system:
```csharp
// Check if tutorial completed
bool tutorialCompleted = PersistentGameManager.Instance.GetCustomDataValue("TutorialCompleted", false);

// Mark tutorial as completed
PersistentGameManager.Instance.SetCustomDataValue("TutorialCompleted", true);
```

### Transition Flow

**First Time (Tutorial Not Completed):**
1. FirstTutorialTrigger detects player collision
2. Checks `TutorialCompleted` flag → false
3. Fades to black
4. Stores post-tutorial destination in PlayerPrefs:
   - `PostTutorialScene` = "Overworld_Entrance"
   - `PostTutorialMarker` = "bottom_entrance"
   - `PostTutorialTransition` = 1
5. Shows tutorial intro dialogue
6. Loads Battle_Tutorial scene
7. Player completes combat
8. SceneTransitionManager.EndCombat() detects `PostTutorialTransition` flag
9. Marks tutorial as completed
10. Transitions to stored post-tutorial scene and marker

**Subsequent Times (Tutorial Completed):**
1. FirstTutorialTrigger detects player collision
2. Checks `TutorialCompleted` flag → true
3. Performs normal scene transition to Overworld_Entrance

## Debugging

### Debug Commands

**In-game (Press F9 to show debug UI):**
- View tutorial completion status under "Custom Data"
- Reset all data with "RESET ALL DATA" button (click twice to confirm)

### Debug Logs

Search for these log tags to trace the flow:
- `[FirstTutorialTrigger]` - Tutorial trigger events
- `[TRANSITION DEBUG]` - Scene transition events
- `[PersistentGameManager]` - Data storage events

### Common Issues

**Issue: Tutorial keeps repeating**
- Check if tutorial completed flag is being set properly
- Look for `[TRANSITION DEBUG] Marked tutorial as completed` in console
- Verify Battle_Tutorial combat is being won (not lost)

**Issue: Player doesn't spawn at correct location**
- Check that Overworld_Entrance has a marker with ID `bottom_entrance`
- Check PlayerPrefs are being saved correctly
- Look for `[TRANSITION DEBUG] Post-tutorial transition to...` in console

**Issue: Dialogue doesn't show**
- Verify TutorialIntro.json is assigned in FirstTutorialTrigger
- Check DialogueManager exists in the scene
- Ensure ScreenFader is set to black

## Customization

### Change Tutorial Dialogue

Edit `Assets/Ink/TutorialIntro.ink`:
```ink
VAR speaker = ""

=== main ===
~ speaker = "The Magician"
Your dialogue here

~ speaker = "The Fighter"
More dialogue...

-> END
```

Unity will auto-compile to `.json`. If not, right-click → "Recompile Ink"

### Change Tutorial Battle Scene

In `FirstTutorialTrigger.cs`, the scene name is hardcoded as "Battle_Tutorial".
To change it, modify the line in `OnDialogueStateChanged`:
```csharp
SceneManager.LoadScene("Battle_Tutorial"); // Change this
```

### Change Post-Tutorial Destination

Set different values in FirstTutorialTrigger component inspector:
- **Target Scene Name**: Any scene name
- **Target Marker Id**: Any marker ID in that scene

## Technical Notes

- Tutorial state persists across game sessions (stored in PersistentGameManager)
- Tutorial completion is also saved when player wins the combat
- If player loses tutorial combat, they return to previous scene without marking tutorial as complete
- The system uses PlayerPrefs for temporary transition data and PersistentGameManager for permanent state

